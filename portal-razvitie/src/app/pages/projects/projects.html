<div class="projects-page">
    <!-- Page Header with Actions -->
    <div class="page-header">
        <div class="header-left">
            <h1 class="page-title">–ü—Ä–æ–µ–∫—Ç—ã</h1>
            <div class="title-underline"></div>
            <p class="page-subtitle">{{ projects.length }} {{ projects.length === 1 ? '–ø—Ä–æ–µ–∫—Ç' : '–ø—Ä–æ–µ–∫—Ç–æ–≤' }}</p>
        </div>
        <div class="header-actions">
            <button class="create-btn" (click)="openCreateModal()">
                <span class="btn-icon">+</span>
                –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
            </button>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="filters-section">
        <div class="search-box">
            <span class="search-icon">üîç</span>
            <input type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –∞–¥—Ä–µ—Å—É, –ì–ò–° –∫–æ–¥—É..." [(ngModel)]="searchQuery">
        </div>
        <div class="filters">
            <select class="filter-select">
                <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                <option *ngFor="let type of projectTypes" [value]="type">{{ type }}</option>
            </select>
            <select class="filter-select">
                <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                <option *ngFor="let status of projectStatuses" [value]="status">{{ status }}</option>
            </select>
        </div>
    </div>

    <!-- Projects List -->
    <div class="projects-grid" *ngIf="!loading && projects.length > 0">
        <!-- Enhanced Project Card -->
        <div class="project-card-enhanced" *ngFor="let project of projects" (click)="viewProject(project)">
            <div class="card-header">
                <div class="card-title-section">
                    <h3 class="card-title">{{ project.store?.name || '–ú–∞–≥–∞–∑–∏–Ω #' + project.storeId }}</h3>
                    <p class="card-code">–ì–ò–°: {{ project.gisCode }}</p>
                </div>
                <span class="project-type-badge">{{ project.projectType }}</span>
            </div>

            <div class="card-status-section">
                <div class="status-indicator" [ngClass]="'status-' + project.status.toLowerCase().replace(/ /g, '-')">
                    <span class="status-dot"></span>
                    <span class="status-text">{{ project.status }}</span>
                </div>
            </div>

            <div class="card-info-grid">
                <div class="info-col">
                    <div class="info-label">üìç –ê–¥—Ä–µ—Å</div>
                    <div class="info-value">{{ (project.store?.address || project.address) | slice:0:50 }}...</div>
                </div>
                <div class="info-col">
                    <div class="info-label">üèôÔ∏è –ì–æ—Ä–æ–¥</div>
                    <div class="info-value">{{ project.store?.city }}</div>
                </div>
                <div class="info-col">
                    <div class="info-label">üìè –ü–ª–æ—â–∞–¥—å</div>
                    <div class="info-value">{{ project.store?.totalArea || project.totalArea }} –º¬≤</div>
                </div>
                <div class="info-col">
                    <div class="info-label">üó∫Ô∏è –†–µ–≥–∏–æ–Ω</div>
                    <div class="info-value">{{ project.store?.region || project.region }}</div>
                </div>
            </div>

            <div class="card-footer">
                <div class="responsible-preview">
                    <span class="resp-label">–ú–ü:</span>
                    <span class="resp-name">{{ project.mp | slice:0:20 }}</span>
                </div>
                <div class="card-action-icon">‚Üí</div>
            </div>
        </div>
    </div>

    <div class="empty-state" *ngIf="!loading && projects.length === 0">
        <p>–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç!</p>
    </div>

    <!-- Create Modal -->
    <div class="modal" *ngIf="showCreateModal" (click)="closeCreateModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <h2>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</h2>

            <div class="form-group">
                <label>–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω *</label>
                <select [(ngModel)]="selectedStoreId" (change)="selectStore()" required>
                    <option [value]="null">-- –í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω --</option>
                    <option *ngFor="let store of stores" [value]="store.id">{{ store.name }} - {{ store.city }}</option>
                </select>
            </div>

            <div class="form-group">
                <label>–¢–∏–ø –ø—Ä–æ–µ–∫—Ç–∞ *</label>
                <select [(ngModel)]="newProject.projectType" required>
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø --</option>
                    <option *ngFor="let type of projectTypes" [value]="type">{{ type }}</option>
                </select>
            </div>

            <div class="form-group">
                <label>–ö–æ–¥ –ì–ò–° *</label>
                <input type="text" [(ngModel)]="newProject.gisCode" required />
            </div>

            <div class="form-group">
                <label>–¶–§–û *</label>
                <select [(ngModel)]="newProject.cfo" required>
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –¶–§–û --</option>
                    <option *ngFor="let cfo of cfoList" [value]="cfo">{{ cfo }}</option>
                </select>
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" (click)="closeCreateModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn-create" (click)="createProject()">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Project Card Modal - Improved UX/UI -->
    <div class="modal" *ngIf="showProjectCard && selectedProject" (click)="closeProjectCard()">
        <div class="project-card-modal" (click)="$event.stopPropagation()">
            <!-- Header -->
            <div class="card-modal-header">
                <div class="header-left">
                    <h2>{{ selectedProject.store?.name || '–ü—Ä–æ–µ–∫—Ç' }}</h2>
                    <div class="project-badges">
                        <span class="badge badge-type">{{ selectedProject.projectType }}</span>
                        <span class="badge badge-status" [ngClass]="'status-' + selectedProject.status.toLowerCase()">
                            {{ selectedProject.status }}
                        </span>
                    </div>
                </div>
                <button class="close-btn" (click)="closeProjectCard()">‚úï</button>
            </div>

            <!-- Content -->
            <div class="card-modal-content">
                <!-- Main Info Card -->
                <div class="info-card">
                    <h3 class="section-title">üìã –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="label">–ö–æ–¥ –ì–ò–°</span>
                            <span class="value">{{ selectedProject.gisCode }}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">–°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞</span>
                            <select class="status-select" [(ngModel)]="selectedProject.status"
                                (change)="updateStatus(selectedProject, selectedProject.status)">
                                <option *ngFor="let status of projectStatuses" [value]="status">{{ status }}</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Object Info Card -->
                <div class="info-card">
                    <h3 class="section-title">üè¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–±—ä–µ–∫—Ç–µ</h3>
                    <div class="info-grid">
                        <div class="info-item full-width">
                            <span class="label">–ê–¥—Ä–µ—Å</span>
                            <span class="value">{{ selectedProject.store?.address || selectedProject.address }}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">–ì–æ—Ä–æ–¥</span>
                            <span class="value">{{ selectedProject.store?.city }}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">–†–µ–≥–∏–æ–Ω</span>
                            <span class="value">{{ selectedProject.store?.region || selectedProject.region }}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">–¶–§–û</span>
                            <span class="value">{{ selectedProject.cfo }}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">–û–±—â–∞—è –ø–ª–æ—â–∞–¥—å</span>
                            <span class="value highlight">{{ selectedProject.store?.totalArea ||
                                selectedProject.totalArea }} –º¬≤</span>
                        </div>
                        <div class="info-item">
                            <span class="label">–¢–æ—Ä–≥–æ–≤–∞—è –ø–ª–æ—â–∞–¥—å</span>
                            <span class="value highlight">{{ selectedProject.store?.tradeArea ||
                                selectedProject.tradeArea }} –º¬≤</span>
                        </div>
                    </div>
                </div>

                <!-- Tasks Card -->
                <div class="info-card">
                    <h3 class="section-title">üìã –ó–∞–¥–∞—á–∏ –ø—Ä–æ–µ–∫—Ç–∞ ({{ projectTasks.length }})</h3>

                    <div class="tasks-list" *ngIf="projectTasks.length > 0">
                        <div class="task-item" *ngFor="let task of projectTasks">
                            <div class="task-header-row">
                                <div class="task-name">{{ task.name }}</div>
                                <span class="task-status-badge" [ngClass]="getTaskStatusClass(task.status)">
                                    {{ task.status }}
                                </span>
                            </div>
                            <div class="task-details">
                                <div class="task-detail">
                                    <span class="detail-icon">üë§</span>
                                    <span>{{ task.responsible }}</span>
                                </div>
                                <div class="task-detail">
                                    <span class="detail-icon">üìÖ</span>
                                    <span>{{ task.normativeDeadline | date:'dd.MM.yyyy' }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="no-tasks" *ngIf="projectTasks.length === 0">
                        <p>–ó–∞–¥–∞—á–∏ –ø–æ–∫–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã</p>
                        <button class="btn-add-task-inline" (click)="openCreateTaskModal()">
                            + –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É
                        </button>
                    </div>
                </div>

                <!-- Responsible Card -->
                <div class="info-card">
                    <h3 class="section-title">üë• –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ</h3>
                    <div class="responsible-grid">
                        <div class="responsible-item">
                            <div class="role">–ú–ü</div>
                            <div class="person">{{ selectedProject.mp }}</div>
                        </div>
                        <div class="responsible-item">
                            <div class="role">–ù–û–†</div>
                            <div class="person">{{ selectedProject.nor }}</div>
                        </div>
                        <div class="responsible-item">
                            <div class="role">–°—Ç–ú–†–∏–ó</div>
                            <div class="person">{{ selectedProject.stMRiZ }}</div>
                        </div>
                        <div class="responsible-item">
                            <div class="role">–†–ù–†</div>
                            <div class="person">{{ selectedProject.rnr }}</div>
                        </div>
                    </div>
                </div>

                <!-- Documents Card -->
                <div class="info-card">
                    <div class="card-header-flex">
                        <h3 class="section-title">üìÇ –î–æ–∫—É–º–µ–Ω—Ç—ã ({{ documents.length }})</h3>
                        <label class="btn-upload">
                            –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç
                            <input type="file" (change)="onFileSelected($event)" hidden>
                        </label>
                    </div>

                    <div class="upload-form" *ngIf="selectedFile">
                        <div class="selected-file-info">
                            <span>{{ selectedFile.name }} ({{ getFriendlyFileSize(selectedFile.size) }})</span>
                            <button class="btn-text-danger"
                                style="color:red; border:none; background:none; cursor:pointer;"
                                (click)="selectedFile = null">‚úï</button>
                        </div>
                        <div class="upload-controls">
                            <select [(ngModel)]="selectedDocType" class="doc-type-select">
                                <option *ngFor="let t of docTypes" [value]="t">{{ t }}</option>
                            </select>
                            <button class="btn-confirm-upload" (click)="uploadDocument()" [disabled]="isUploading">
                                {{ isUploading ? '–ó–∞–≥—Ä—É–∑–∫–∞...' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' }}
                            </button>
                        </div>
                    </div>

                    <div class="documents-list">
                        <div class="document-item" *ngFor="let doc of documents">
                            <div class="doc-icon">üìÑ</div>
                            <div class="doc-info">
                                <div class="doc-name">{{ doc.name }}</div>
                                <div class="doc-meta">
                                    {{ doc.type }} ‚Ä¢ v{{ doc.version }} ‚Ä¢ {{ doc.uploadDate | date:'dd.MM.yyyy' }}
                                </div>
                            </div>
                            <div class="doc-actions">
                                <button (click)="downloadDoc(doc)" title="–°–∫–∞—á–∞—Ç—å">‚¨áÔ∏è</button>
                                <button (click)="deleteDoc(doc)" title="–£–¥–∞–ª–∏—Ç—å" class="btn-delete">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div *ngIf="documents.length === 0" style="text-align:center; padding:20px; color:#888;">
                            –ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer Actions -->
            <div class="card-modal-footer">
                <button class="btn-action btn-primary" (click)="openGanttModal()">üìä –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≥—Ä–∞—Ñ–∏–∫ –∑–∞–¥–∞—á</button>
                <button class="btn-action btn-secondary" (click)="openCreateTaskModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
                <button class="btn-action btn-tertiary" (click)="closeProjectCard()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Create Task Modal -->
    <div class="modal" *ngIf="showCreateTaskModal" (click)="closeCreateTaskModal()">
        <div class="task-modal-content" (click)="$event.stopPropagation()">
            <h2>‚ú® –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</h2>
            <p class="modal-subtitle">–ü–æ–ª—è –∑–∞–ø–æ–ª–Ω—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ç–∏–ø–∞ –∑–∞–¥–∞—á–∏</p>

            <div class="form-group">
                <label>–¢–∏–ø –∑–∞–¥–∞—á–∏ *</label>
                <select [(ngModel)]="newTask.taskType" (change)="onTaskTypeChange()" required>
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø --</option>
                    <option *ngFor="let type of taskTypes" [value]="type">{{ type }}</option>
                </select>
            </div>

            <div class="form-group" *ngIf="newTask.taskType">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</label>
                <input type="text" [(ngModel)]="newTask.name" />
            </div>

            <div class="form-row" *ngIf="newTask.taskType">
                <div class="form-group">
                    <label>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</label>
                    <input type="text" [(ngModel)]="newTask.responsible" />
                </div>

                <div class="form-group">
                    <label>–ù–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π —Å—Ä–æ–∫</label>
                    <input type="date" [(ngModel)]="newTask.normativeDeadline" />
                </div>
            </div>

            <div class="form-group" *ngIf="newTask.taskType">
                <label>–°—Ç–∞—Ç—É—Å</label>
                <select [(ngModel)]="newTask.status">
                    <option *ngFor="let status of taskStatuses" [value]="status">{{ status }}</option>
                </select>
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" (click)="closeCreateTaskModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn-create" (click)="createTask()" [disabled]="!newTask.taskType">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
            </div>
        </div>
    </div>

    <!-- Gantt Chart Modal -->
    <div class="modal" *ngIf="showGanttModal" (click)="closeGanttModal()">
        <div class="gantt-modal-content" (click)="$event.stopPropagation()">
            <div class="card-modal-header">
                <div class="header-left">
                    <h2>–ì—Ä–∞—Ñ–∏–∫ –∑–∞–¥–∞—á</h2>
                    <p class="gantt-subtitle">{{ selectedProject?.store?.name }}</p>
                </div>
                <button class="close-btn" (click)="closeGanttModal()">‚úï</button>
            </div>

            <div class="gantt-container" *ngIf="ganttDates.length > 0">
                <!-- Header Dates -->
                <div class="gantt-header">
                    <div class="gantt-task-col">–ó–∞–¥–∞—á–∞</div>
                    <div class="gantt-timeline-header">
                        <div class="gantt-date-cell" *ngFor="let date of ganttDates">
                            {{ date | date:'dd' }}<br>
                            <span class="month-label">{{ date | date:'MMM' }}</span>
                        </div>
                    </div>
                </div>

                <!-- Tasks Rows -->
                <div class="gantt-body">
                    <div class="gantt-row" *ngFor="let task of projectTasks">
                        <div class="gantt-task-col task-name-cell" [title]="task.name">
                            {{ task.name }}
                        </div>
                        <div class="gantt-timeline-row">
                            <!-- Grid lines -->
                            <div class="gantt-grid-line" *ngFor="let date of ganttDates"></div>

                            <!-- Task Bar -->
                            <div class="gantt-bar-container" [style.left.px]="getTaskStartOffset(task) * 40"
                                [style.width.px]="getTaskDuration(task) * 40">
                                <div class="gantt-bar" [ngClass]="getTaskStatusClass(task.status)"
                                    [title]="task.name + '\n' + (task.normativeDeadline | date:'dd.MM.yyyy')">
                                    <span class="bar-label">{{ getTaskDuration(task) }} –¥–Ω.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>