# Техническое задание на разработку портала управления лицензиями

**Версия документа:** 1.0  
**Дата:** 2024  
**Статус:** Актуальная версия

---

## 1. Общее описание проекта

### 1.1. Назначение системы

Портал управления лицензиями (Licensing Portal) — веб-приложение для управления процессом получения, продления и контроля лицензий на розничную продажу алкогольной и табачной продукции. Система предназначена для автоматизации работы с лицензионными процедурами, управления документами, отслеживания платежей и контроля сроков действия лицензий.

### 1.2. Целевая аудитория

- **Менеджеры по лицензированию** — основная группа пользователей, работающая с задачами и документами
- **Администраторы** — управление пользователями, справочниками и настройками системы
- **Руководители** — просмотр отчетов и аналитики

### 1.3. Цели и задачи проекта

**Основные цели:**
- Автоматизация процессов управления лицензиями
- Централизованное хранение и управление документами
- Контроль сроков действия лицензий и уведомления о приближающихся датах истечения
- Отслеживание платежей (госпошлины, штрафы)
- Интеграция с внешними системами (ЕГРН, ГИС, ФИАС)
- Аналитика и отчетность по лицензиям

**Задачи:**
- Создание единой базы данных магазинов и лицензий
- Автоматизация создания задач на получение/продление лицензий
- Управление документами и их версиями
- Интеграция с платежными системами
- Визуализация данных на карте
- Настраиваемый дашборд для пользователей

---

## 2. Технические требования

### 2.1. Технологический стек

#### 2.1.1. Backend

- **Язык программирования:** Java 17
- **Фреймворк:** Spring Boot 3.2.0
- **База данных:** PostgreSQL 15+
- **ORM:** JPA/Hibernate
- **Миграции БД:** Flyway
- **Безопасность:** Spring Security + JWT (jjwt 0.12.3)
- **Валидация:** Jakarta Bean Validation
- **Email:** Spring Mail (SMTP)
- **Сборка:** Maven 3.8+
- **Утилиты:** Lombok

#### 2.1.2. Frontend

- **Язык программирования:** TypeScript 5.9+
- **Фреймворк:** React 19.2+
- **Сборщик:** Vite 7.2+
- **UI библиотека:** Ant Design 6.0+
- **Маршрутизация:** React Router v7.9+
- **HTTP клиент:** Axios 1.13+
- **Drag & Drop:** @dnd-kit 6.3+
- **Карты:** @pbe/react-yandex-maps 1.2+
- **Графики:** Recharts 3.5+
- **Утилиты:** dayjs 1.11+

#### 2.1.3. Инфраструктура

- **Веб-сервер:** Встроенный Spring Boot (Tomcat)
- **Прокси:** Nginx (рекомендуется для production)
- **Контейнеризация:** Docker (опционально)
- **CI/CD:** GitLab CI / GitHub Actions (опционально)

### 2.2. Системные требования

#### 2.2.1. Сервер

- **ОС:** Linux (Ubuntu 20.04+, CentOS 8+) / Windows Server 2019+
- **CPU:** 2+ ядра
- **RAM:** 4+ GB
- **Диск:** 20+ GB свободного места
- **Java:** OpenJDK 17 или Oracle JDK 17

#### 2.2.2. База данных

- **PostgreSQL:** 15.0+
- **RAM:** 2+ GB
- **Диск:** 10+ GB (зависит от объема данных)

#### 2.2.3. Клиент

- **Браузеры:** Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
- **Разрешение экрана:** 1280x720 и выше
- **JavaScript:** Включен

### 2.3. Порты и сеть

- **Backend API:** 8081
- **Frontend Dev Server:** 5174
- **PostgreSQL:** 5432
- **SMTP:** 587 (TLS)

---

## 3. Функциональные требования

### 3.1. Модуль аутентификации и авторизации

#### 3.1.1. Аутентификация

**FR-AUTH-001:** Система должна предоставлять форму входа с полями:
- Имя пользователя (username)
- Пароль (password)

**FR-AUTH-002:** Система должна использовать JWT токены для аутентификации:
- Токен должен быть действителен 24 часа
- Токен должен передаваться в заголовке `Authorization: Bearer <token>`
- При истечении токена пользователь должен быть перенаправлен на страницу входа

**FR-AUTH-003:** Система должна предоставлять эндпоинт `/api/auth/login` для входа

**FR-AUTH-004:** Система должна предоставлять эндпоинт `/api/auth/me` для получения информации о текущем пользователе

#### 3.1.2. Авторизация

**FR-AUTH-005:** Система должна поддерживать ролевую модель доступа:
- Роли хранятся в таблице `user_roles`
- Одна роль может быть назначена нескольким пользователям
- Пользователь может иметь несколько ролей

**FR-AUTH-006:** Система должна проверять права доступа на уровне API endpoints

### 3.2. Модуль управления пользователями

#### 3.2.1. Профиль пользователя

**FR-USER-001:** Система должна хранить следующую информацию о пользователе:
- ID (автогенерируемый)
- Имя пользователя (уникальное, до 50 символов)
- Email (уникальный)
- Хеш пароля (BCrypt)
- Полное имя (до 100 символов)
- Должность (до 100 символов, опционально)
- Отдел (до 100 символов, опционально)
- Роли (множественное значение)
- Дата создания
- Статус активности (активен/неактивен)

**FR-USER-002:** Система должна отображать информацию о текущем пользователе в боковой панели

### 3.3. Модуль управления магазинами

#### 3.3.1. Справочник магазинов

**FR-STORE-001:** Система должна предоставлять список всех магазинов с возможностью:
- Просмотра в табличном виде
- Поиска и фильтрации
- Сортировки по колонкам
- Пагинации (10, 20, 50, 100 записей на странице)

**FR-STORE-002:** Система должна хранить следующую информацию о магазине:
- ID (автогенерируемый)
- МВЗ (до 10 символов)
- Название (обязательное, до 200 символов)
- Адрес (обязательное, до 300 символов)
- ЦФО (до 10 символов)
- ОКТМО (до 11 символов)
- Флаг наличия ограничений (boolean)
- Муниципальная область (до 100 символов)
- Муниципальный район (до 100 символов)
- Бизнес-единица (до 200 символов)
- Дата закрытия (опционально)
- Телефон директора (до 20 символов)
- ИНН (уникальный, обязательный, 10 или 12 цифр)
- КПП (9 цифр, опционально)
- Контактное лицо (до 100 символов)
- Телефон (до 20 символов)
- Email (до 100 символов)
- Дата истечения алкогольной лицензии (опционально)
- Дата истечения табачной лицензии (опционально)
- Статус активности (boolean, по умолчанию true)

**FR-STORE-003:** Система должна предоставлять возможность создания нового магазина через форму:
- Валидация обязательных полей
- Проверка уникальности ИНН
- Проверка формата ИНН (10 или 12 цифр)
- Проверка формата КПП (9 цифр)
- Проверка формата email
- Проверка формата телефона

**FR-STORE-004:** Система должна предоставлять API endpoints:
- `GET /api/references/stores` — получение списка магазинов
- `GET /api/references/stores/{id}` — получение магазина по ID
- `POST /api/references/stores` — создание магазина

**FR-STORE-005:** Система должна отображать в таблице магазинов:
- Номер
- МВЗ
- Название (с иконкой)
- Адрес
- ЦФО
- ОКТМО
- Наличие ограничений (цветной тег)
- Муниципальная область
- Муниципальный район
- Бизнес-единица
- Дата закрытия
- Лицензии (алкоголь и табак с датами истечения)
- Статус активности (цветной тег)

**FR-STORE-006:** Система должна рассчитывать статистику лицензий:
- Общее количество активных магазинов
- Количество активных алкогольных лицензий
- Количество истекающих алкогольных лицензий (в течение 3 месяцев)
- Количество истекших алкогольных лицензий
- Количество активных табачных лицензий
- Количество истекающих табачных лицензий (в течение 3 месяцев)
- Количество истекших табачных лицензий

### 3.4. Модуль управления регионами

#### 3.4.1. Справочник регионов

**FR-REGION-001:** Система должна хранить информацию о регионах:
- ID (автогенерируемый)
- Тип лицензии (до 100 символов)
- Название региона (обязательное, до 200 символов)
- Код региона (до 50 символов)
- ГИИД региона (до 100 символов)
- Код контрагента (до 50 символов)
- ИНН контрагента (до 20 символов)
- КПП (до 20 символов)
- БИК расчетного счета (до 20 символов)
- Дата создания
- Дата обновления

**FR-REGION-002:** Система должна предоставлять API endpoints:
- `GET /api/references/regions` — получение списка регионов
- `GET /api/references/regions/{id}` — получение региона по ID
- `POST /api/references/regions` — создание региона
- `PUT /api/references/regions/{id}` — обновление региона
- `DELETE /api/references/regions/{id}` — удаление региона

**FR-REGION-003:** Система должна автоматически обновлять поле `updated_at` при изменении записи

### 3.5. Модуль управления платежами

#### 3.5.1. Создание платежей

**FR-PAYMENT-001:** Система должна поддерживать два типа создания платежей:
- Обычная оплата (единичный платеж)
- Массовая оплата (загрузка реестра)

**FR-PAYMENT-002:** Система должна хранить следующую информацию о платеже:
- ID (автогенерируемый)
- Сумма (обязательное, decimal 10,2)
- Статус (PENDING, COMPLETED, FAILED, CANCELLED)
- Дата платежа (опционально)
- Референс платежа (до 100 символов)
- Примечания (TEXT)
- Тип платежа (STATE_FEE, FINE, OTHER)
- ID задачи (опционально, связь с задачей)
- Регион (до 100 символов)
- Розничная сеть (до 100 символов)
- Юридическое лицо (до 100 символов)
- Получатель платежа (до 100 символов)
- ОКТМО (до 20 символов)
- Флаг необходимости банковской отметки (boolean, по умолчанию false)
- Список магазинов (Many-to-Many связь)
- Дата создания

**FR-PAYMENT-003:** Система должна предоставлять API endpoints:
- `GET /api/payments` — получение списка платежей
- `GET /api/payments/{id}` — получение платежа по ID
- `POST /api/payments` — создание платежа
- `PUT /api/payments/{id}/status?status={status}` — обновление статуса платежа

**FR-PAYMENT-004:** Система должна отображать список платежей в таблице с колонками:
- Номер
- Дата создания
- Тип платежа
- Сумма (с валютой ₽)
- Регион
- Статус (цветной тег)

**FR-PAYMENT-005:** Система должна отображать статусы платежей цветными тегами:
- PENDING — оранжевый
- COMPLETED — зеленый
- FAILED — красный
- CANCELLED — серый

**FR-PAYMENT-006:** Система должна отображать типы платежей в читаемом виде:
- STATE_FEE → "Госпошлина"
- FINE → "Штраф"
- OTHER → "Другое"

**FR-PAYMENT-007:** Система должна поддерживать пагинацию списка платежей (10 записей на страницу по умолчанию)

### 3.6. Модуль управления задачами

#### 3.6.1. Задачи на лицензирование

**FR-TASK-001:** Система должна хранить информацию о задачах:
- ID (автогенерируемый)
- Заголовок (обязательное)
- Описание
- Тип лицензии (ALCOHOL, TOBACCO)
- Тип действия (NEW, RENEWAL, REPLACEMENT)
- Статус (DRAFT, ASSIGNED, IN_PROGRESS, DONE, CANCELLED)
- ID магазина (связь с магазином)
- ID исполнителя (связь с пользователем)
- ID создателя (связь с пользователем)
- Дата дедлайна
- Дата создания
- Дата обновления

**FR-TASK-002:** Система должна поддерживать разделы задачи:
- **GIS раздел:**
  - Дата оценки ГИС
  - Комментарий ГИС
  - Статус ГИС (NOT_STARTED, IN_PROGRESS, COMPLETED, SKIPPED)
- **EGRN раздел:**
  - Дата запроса ЕГРН
  - Статус ЕГРН (NOT_STARTED, IN_PROGRESS, COMPLETED, SKIPPED)
- **FIAS раздел:**
  - Дата проверки ФИАС
  - Статус ФИАС (NOT_STARTED, IN_PROGRESS, COMPLETED, SKIPPED)
- **Документы:**
  - Статус загрузки документов (NOT_STARTED, IN_PROGRESS, COMPLETED, SKIPPED)
- **Платежи:**
  - Статус платежа (NOT_STARTED, IN_PROGRESS, COMPLETED, SKIPPED)

**FR-TASK-003:** Система должна предоставлять API endpoints:
- `GET /api/tasks` — получение списка задач
- `GET /api/tasks/{id}` — получение задачи по ID
- `POST /api/tasks` — создание задачи
- `PUT /api/tasks/{id}` — обновление задачи
- `DELETE /api/tasks/{id}` — удаление задачи

**FR-TASK-004:** Система должна отображать страницу задач (в разработке)

### 3.7. Модуль управления документами

#### 3.7.1. Выписки ЕГРН

**FR-DOC-EGRN-001:** Система должна хранить информацию о выписках ЕГРН:
- ID (автогенерируемый)
- Тип заявителя
- Телефон
- Email
- Кадастровый номер
- Тип объекта
- МВЗ
- Статус (DRAFT, SUBMITTED, PROCESSING, COMPLETED, REJECTED)
- Дата создания

**FR-DOC-EGRN-002:** Система должна предоставлять API endpoints:
- `GET /api/egrn-extracts` — получение списка выписок
- `GET /api/egrn-extracts/{id}` — получение выписки по ID
- `POST /api/egrn-extracts` — создание выписки

**FR-DOC-EGRN-003:** Система должна предоставлять страницы:
- `/documents/egrn-list` — список выписок ЕГРН
- `/documents/egrn/create` — создание новой выписки
- `/documents/egrn/{id}` — просмотр/редактирование выписки

#### 3.7.2. Документы

**FR-DOC-002:** Система должна хранить информацию о документах:
- ID (автогенерируемый)
- Тип документа (до 100 символов)
- Имя файла (до 255 символов)
- Путь к файлу (до 500 символов)
- Размер файла (bytes)
- Статус (UPLOADED, VERIFIED, REJECTED)
- Дата загрузки
- ID пользователя, загрузившего документ

**FR-DOC-003:** Система должна предоставлять страницу `/documents` для управления документами

#### 3.7.3. GIS анализ

**FR-DOC-GIS-001:** Система должна предоставлять страницу `/documents/gis` для анализа локации в ГИС

#### 3.7.4. Проверка адреса ФИАС

**FR-DOC-FIAS-001:** Система должна предоставлять функционал проверки адреса магазина через ФИАС:
- Выбор магазина из справочника
- Отображение адреса магазина
- Кнопка "Проверить" для запуска проверки
- Отображение результата проверки

### 3.8. Модуль дашборда

#### 3.8.1. Главная страница

**FR-DASH-001:** Система должна предоставлять настраиваемый дашборд с виджетами:
- Уведомления
- Действия
- Справочники
- Карта магазинов

**FR-DASH-002:** Система должна поддерживать перетаскивание виджетов (drag & drop):
- Виджеты можно менять местами
- Порядок сохраняется в localStorage
- Порядок восстанавливается при следующем входе

**FR-DASH-003:** Система должна поддерживать скрытие/показ виджетов:
- Чекбоксы в настройках дашборда
- Состояние сохраняется в localStorage

**FR-DASH-004:** Система должна отображать уведомления о:
- Истекших алкогольных лицензиях (красный Alert)
- Истекших табачных лицензиях (красный Alert)
- Истекающих алкогольных лицензиях (оранжевый Alert, в течение 30 дней)
- Истекающих табачных лицензиях (оранжевый Alert, в течение 30 дней)

**FR-DASH-005:** Система должна поддерживать закрытие уведомлений:
- Кнопка закрытия на каждом Alert
- Закрытые уведомления не показываются при следующем входе
- Состояние сохраняется в localStorage

**FR-DASH-006:** Система должна отображать секцию "Действия" с тайлами:
- Договоры аренды (в разработке, неактивный)
- Государственные пошлины (активный, переход на `/payments`)
- Выписки ЕГРН (активный, переход на `/documents/egrn-list`)
- Анализ локации в ГИС (активный, переход на `/documents/gis`)
- Проверка адреса ФИАС (активный, открывает модальное окно)

**FR-DASH-007:** Система должна поддерживать перетаскивание тайлов внутри секций:
- Тайлы в секции "Действия" можно менять местами
- Тайлы в секции "Справочники" можно менять местами
- Порядок сохраняется в localStorage

**FR-DASH-008:** Система должна отображать секцию "Общая информация" с тайлами:
- Магазины (с количеством и трендом)
- Алкогольные лицензии (с количеством, трендом и тегом истекающих)
- Табачные лицензии (с количеством, трендом и тегом истекающих)
- Регионы РФ (с количеством)

**FR-DASH-009:** Система должна отображать карту магазинов:
- Интеграция с Yandex Maps API
- Отображение всех магазинов на карте
- Placemark для каждого магазина с информацией:
  - Название магазина
  - Адрес
  - Телефон
- Автоматическое масштабирование при изменении размера контейнера

**FR-DASH-010:** Система должна предоставлять настройки дашборда:
- Drawer с настройками (открывается по клику на иконку настроек)
- Чекбоксы для управления видимостью виджетов
- Кнопка "Сбросить настройки" для восстановления значений по умолчанию

**FR-DASH-011:** Система должна рассчитывать и отображать тренды:
- Процент изменения количества магазинов за последние 7 дней
- Процент изменения количества алкогольных лицензий за последние 7 дней
- Процент изменения количества табачных лицензий за последние 7 дней
- Отображение тренда с иконкой стрелки вверх и процентом

### 3.9. Модуль справочников лицензий

#### 3.9.1. Алкогольные лицензии

**FR-REF-ALC-001:** Система должна предоставлять страницу `/references/alcohol` для просмотра алкогольных лицензий:
- Список магазинов с алкогольными лицензиями
- Фильтрация по статусу (активные, истекающие, истекшие)
- Отображение даты истечения лицензии

#### 3.9.2. Табачные лицензии

**FR-REF-TOB-001:** Система должна предоставлять страницу `/references/tobacco` для просмотра табачных лицензий:
- Список магазинов с табачными лицензиями
- Фильтрация по статусу (активные, истекающие, истекшие)
- Отображение даты истечения лицензии

### 3.10. Модуль уведомлений

#### 3.10.1. Системные уведомления

**FR-NOTIF-001:** Система должна хранить уведомления:
- ID (автогенерируемый)
- ID пользователя (связь с пользователем)
- Сообщение (TEXT, обязательное)
- Тип уведомления (DEADLINE_WARNING, TASK_ASSIGNED, DOCUMENT_UPLOADED, PAYMENT_COMPLETED, STATUS_CHANGED, GENERAL)
- Флаг прочитанности (boolean, по умолчанию false)
- Дата создания

**FR-NOTIF-002:** Система должна автоматически создавать уведомления при:
- Приближении дедлайна задачи
- Назначении задачи пользователю
- Загрузке документа
- Завершении платежа
- Изменении статуса задачи

---

## 4. Нефункциональные требования

### 4.1. Производительность

**NFR-PERF-001:** Время отклика API должно быть не более 200ms для 95% запросов

**NFR-PERF-002:** Время загрузки страницы должно быть не более 2 секунд при скорости интернета 10 Мбит/с

**NFR-PERF-003:** Система должна поддерживать одновременную работу не менее 50 пользователей

**NFR-PERF-004:** Система должна обрабатывать не менее 1000 запросов в минуту

### 4.2. Безопасность

**NFR-SEC-001:** Все пароли должны храниться в зашифрованном виде (BCrypt)

**NFR-SEC-002:** JWT токены должны содержать минимально необходимую информацию

**NFR-SEC-003:** Система должна защищаться от SQL-инъекций (использование JPA/Hibernate)

**NFR-SEC-004:** Система должна защищаться от XSS атак (валидация и санитизация входных данных)

**NFR-SEC-005:** Система должна использовать HTTPS в production окружении

**NFR-SEC-006:** Система должна логировать все попытки входа (успешные и неуспешные)

### 4.3. Надежность

**NFR-REL-001:** Система должна иметь доступность не менее 99% (uptime)

**NFR-REL-002:** Система должна автоматически восстанавливаться после сбоев

**NFR-REL-003:** Система должна иметь резервное копирование базы данных (ежедневно)

**NFR-REL-004:** Система должна иметь механизм отката миграций БД

### 4.4. Масштабируемость

**NFR-SCAL-001:** Архитектура должна позволять горизонтальное масштабирование backend

**NFR-SCAL-002:** База данных должна поддерживать индексы для оптимизации запросов

**NFR-SCAL-003:** Система должна использовать кэширование для часто запрашиваемых данных (опционально)

### 4.5. Удобство использования

**NFR-USAB-001:** Интерфейс должен быть интуитивно понятным для пользователей

**NFR-USAB-002:** Система должна поддерживать русский язык интерфейса

**NFR-USAB-003:** Система должна предоставлять подсказки и валидацию форм

**NFR-USAB-004:** Система должна отображать понятные сообщения об ошибках

**NFR-USAB-005:** Система должна поддерживать адаптивный дизайн (responsive)

### 4.6. Совместимость

**NFR-COMP-001:** Система должна работать в современных браузерах (Chrome, Firefox, Safari, Edge)

**NFR-COMP-002:** Система должна поддерживать разрешения экрана от 1280x720

**NFR-COMP-003:** Backend API должен следовать RESTful принципам

### 4.7. Поддерживаемость

**NFR-MAIN-001:** Код должен быть документирован (JavaDoc, комментарии)

**NFR-MAIN-002:** Система должна использовать логирование (SLF4J + Logback)

**NFR-MAIN-003:** Система должна иметь версионирование API

**NFR-MAIN-004:** Система должна использовать миграции БД для управления схемой

---

## 5. Архитектура системы

### 5.1. Общая архитектура

Система построена по принципу клиент-серверной архитектуры с разделением на три основных слоя:

```
┌─────────────────────────────────────────────────────────┐
│                    Frontend (React)                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐             │
│  │  Pages   │  │Components│  │ Services │             │
│  └──────────┘  └──────────┘  └──────────┘             │
└─────────────────────────────────────────────────────────┘
                          │
                    HTTP/REST API
                          │
┌─────────────────────────────────────────────────────────┐
│              Backend (Spring Boot)                       │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐             │
│  │Controller│  │ Service  │  │Repository│             │
│  └──────────┘  └──────────┘  └──────────┘             │
└─────────────────────────────────────────────────────────┘
                          │
                    JDBC/JPA
                          │
┌─────────────────────────────────────────────────────────┐
│              Database (PostgreSQL)                       │
└─────────────────────────────────────────────────────────┘
```

### 5.2. Структура Backend

```
backend/
├── src/main/java/com/licensing/portal/
│   ├── PortalApplication.java          # Точка входа
│   ├── config/                          # Конфигурация
│   │   ├── SecurityConfig.java          # Spring Security
│   │   ├── WebConfig.java               # CORS, Web настройки
│   │   └── RegionInitializer.java       # Инициализация данных
│   ├── controller/                      # REST Controllers
│   │   ├── AuthController.java
│   │   ├── StoreController.java
│   │   ├── RegionController.java
│   │   ├── PaymentController.java
│   │   ├── EgrnExtractController.java
│   │   ├── EmailController.java
│   │   ├── UserController.java
│   │   └── HealthController.java
│   ├── service/                         # Бизнес-логика
│   │   ├── CustomUserDetailsService.java
│   │   ├── PaymentService.java
│   │   ├── RegionService.java
│   │   ├── EgrnExtractService.java
│   │   ├── EmailService.java
│   │   └── DataInitializer.java
│   ├── repository/                      # JPA Repositories
│   │   ├── UserRepository.java
│   │   ├── StoreRepository.java
│   │   ├── RegionRepository.java
│   │   ├── PaymentRepository.java
│   │   ├── DocumentRepository.java
│   │   ├── EgrnExtractRepository.java
│   │   └── NotificationRepository.java
│   ├── model/                           # JPA Entities
│   │   ├── User.java
│   │   ├── Store.java
│   │   ├── Region.java
│   │   ├── Payment.java
│   │   ├── Document.java
│   │   ├── EgrnExtract.java
│   │   └── Notification.java
│   ├── dto/                             # Data Transfer Objects
│   │   ├── LoginRequest.java
│   │   ├── LoginResponse.java
│   │   ├── PaymentRequest.java
│   │   ├── PaymentResponse.java
│   │   └── UpdatePaymentStatusRequest.java
│   └── security/                         # Security
│       ├── JwtTokenProvider.java
│       └── JwtAuthenticationFilter.java
└── src/main/resources/
    ├── application.yml                   # Конфигурация приложения
    └── db/migration/                     # Flyway миграции
        ├── V2__add_store_fields.sql
        ├── V3__add_task_workflow_fields.sql
        └── V4__add_test_tasks.sql
```

### 5.3. Структура Frontend

```
frontend/
├── src/
│   ├── main.tsx                         # Точка входа
│   ├── App.tsx                          # Главный компонент, роутинг
│   ├── index.css                        # Глобальные стили
│   ├── theme.css                        # Тема приложения
│   ├── pages/                           # Страницы
│   │   ├── Login.tsx
│   │   ├── Dashboard.tsx
│   │   ├── Tasks.tsx
│   │   ├── Stores.tsx
│   │   ├── Regions.tsx
│   │   ├── Payments.tsx
│   │   ├── CreatePayment.tsx
│   │   ├── CreateMassPayment.tsx
│   │   ├── Documents.tsx
│   │   ├── EgrnExtract.tsx
│   │   ├── EgrnList.tsx
│   │   ├── GisAnalysis.tsx
│   │   ├── AlcoholLicenses.tsx
│   │   └── TobaccoLicenses.tsx
│   ├── components/                      # Компоненты
│   │   ├── Layout.tsx                   # Основной layout
│   │   ├── Layout.css
│   │   ├── Logo.tsx
│   │   ├── SortableWidget.tsx
│   │   ├── SortableTile.tsx
│   │   └── Sparkline.tsx
│   ├── services/                        # API сервисы
│   │   ├── api.ts                       # Axios конфигурация
│   │   ├── authService.ts
│   │   ├── storeService.ts
│   │   ├── regionService.ts
│   │   ├── paymentService.ts
│   │   ├── egrnService.ts
│   │   └── userService.ts
│   ├── types/                           # TypeScript типы
│   │   └── index.ts
│   └── context/                         # React контексты
│       └── ThemeContext.tsx
├── public/
└── package.json
```

### 5.4. Схема базы данных

#### 5.4.1. Таблицы

**users**
- id (BIGSERIAL PRIMARY KEY)
- username (VARCHAR(50) UNIQUE NOT NULL)
- password_hash (VARCHAR NOT NULL)
- email (VARCHAR UNIQUE NOT NULL)
- full_name (VARCHAR(100) NOT NULL)
- position (VARCHAR(100))
- department (VARCHAR(100))
- created_at (TIMESTAMP)
- is_active (BOOLEAN DEFAULT TRUE)

**user_roles**
- user_id (BIGINT FOREIGN KEY → users.id)
- role (VARCHAR)

**stores**
- id (BIGSERIAL PRIMARY KEY)
- mvz (VARCHAR(10))
- name (VARCHAR(200) NOT NULL)
- address (VARCHAR(300) NOT NULL)
- cfo (VARCHAR(10))
- oktmo (VARCHAR(11))
- has_restriction (BOOLEAN DEFAULT FALSE)
- mun_area (VARCHAR(100))
- mun_district (VARCHAR(100))
- be (VARCHAR(200))
- close_date (DATE)
- director_phone (VARCHAR(20))
- inn (VARCHAR(12) UNIQUE NOT NULL)
- kpp (VARCHAR(9))
- contact_person (VARCHAR(100))
- phone (VARCHAR(20))
- email (VARCHAR(100))
- alcohol_license_expiry (DATE)
- tobacco_license_expiry (DATE)
- is_active (BOOLEAN DEFAULT TRUE)

**regions**
- id (BIGSERIAL PRIMARY KEY)
- license_type (VARCHAR(100))
- name (VARCHAR(200) NOT NULL)
- region_code (VARCHAR(50))
- region_giid (VARCHAR(100))
- counterparty_code (VARCHAR(50))
- counterparty_inn (VARCHAR(20))
- kpp (VARCHAR(20))
- settlement_bik (VARCHAR(20))
- created_at (TIMESTAMP)
- updated_at (TIMESTAMP)

**payments**
- id (BIGSERIAL PRIMARY KEY)
- amount (DECIMAL(10,2) NOT NULL)
- status (VARCHAR(20) NOT NULL)
- payment_date (TIMESTAMP)
- payment_reference (VARCHAR(100))
- notes (TEXT)
- type (VARCHAR(20))
- task_id (BIGINT)
- region (VARCHAR(100))
- retail_network (VARCHAR(100))
- legal_entity (VARCHAR(100))
- payment_recipient (VARCHAR(100))
- oktmo (VARCHAR(20))
- bank_mark_required (BOOLEAN DEFAULT FALSE)
- created_at (TIMESTAMP)

**payment_stores** (Many-to-Many)
- payment_id (BIGINT FOREIGN KEY → payments.id)
- store_id (BIGINT FOREIGN KEY → stores.id)

**documents**
- id (BIGSERIAL PRIMARY KEY)
- document_type (VARCHAR(100) NOT NULL)
- file_name (VARCHAR(255) NOT NULL)
- file_path (VARCHAR(500) NOT NULL)
- file_size (BIGINT)
- status (VARCHAR(20) NOT NULL)
- upload_date (TIMESTAMP)
- uploaded_by_id (BIGINT FOREIGN KEY → users.id)

**egrn_extracts**
- id (BIGSERIAL PRIMARY KEY)
- applicant_type (VARCHAR)
- phone (VARCHAR)
- email (VARCHAR)
- cadastral_number (VARCHAR)
- object_type (VARCHAR)
- mvz (VARCHAR)
- status (VARCHAR NOT NULL)
- created_at (TIMESTAMP)

**notifications**
- id (BIGSERIAL PRIMARY KEY)
- user_id (BIGINT FOREIGN KEY → users.id NOT NULL)
- message (TEXT NOT NULL)
- type (VARCHAR(20) NOT NULL)
- is_read (BOOLEAN DEFAULT FALSE)
- created_at (TIMESTAMP)

**tasks** (планируется)
- id (BIGSERIAL PRIMARY KEY)
- title (VARCHAR NOT NULL)
- description (TEXT)
- license_type (VARCHAR)
- action_type (VARCHAR)
- status (VARCHAR)
- store_id (BIGINT FOREIGN KEY → stores.id)
- assignee_id (BIGINT FOREIGN KEY → users.id)
- created_by_id (BIGINT FOREIGN KEY → users.id)
- deadline_date (DATE)
- planned_start_date (DATE)
- planned_end_date (DATE)
- actual_start_date (DATE)
- actual_end_date (DATE)
- gis_assessment_date (DATE)
- gis_comment (TEXT)
- gis_status (VARCHAR)
- egrn_request_date (DATE)
- egrn_status (VARCHAR)
- fias_check_date (DATE)
- fias_status (VARCHAR)
- document_upload_status (VARCHAR)
- payment_status (VARCHAR)
- created_at (TIMESTAMP)
- updated_at (TIMESTAMP)

#### 5.4.2. Индексы

- `users.username` (UNIQUE)
- `users.email` (UNIQUE)
- `stores.inn` (UNIQUE)
- `tasks.parent_task_id` (если используется)
- `tasks.subtask_type` (если используется)

### 5.5. API Архитектура

#### 5.5.1. RESTful принципы

- Использование HTTP методов: GET, POST, PUT, DELETE
- Ресурсы в URL: `/api/references/stores`
- Статус коды: 200 (OK), 201 (Created), 400 (Bad Request), 401 (Unauthorized), 404 (Not Found), 500 (Internal Server Error)
- JSON формат данных

#### 5.5.2. Аутентификация

- JWT токен в заголовке: `Authorization: Bearer <token>`
- Токен содержит: username, roles, expiration
- Время жизни токена: 24 часа

#### 5.5.3. CORS

- Настройка CORS для разрешения запросов с frontend домена
- В development: разрешены все источники
- В production: только разрешенные домены

---

## 6. API Спецификация

### 6.1. Аутентификация

#### POST /api/auth/login
**Описание:** Аутентификация пользователя

**Request Body:**
```json
{
  "username": "string",
  "password": "string"
}
```

**Response 200:**
```json
{
  "token": "string",
  "type": "Bearer",
  "id": 1,
  "username": "string",
  "email": "string",
  "fullName": "string",
  "roles": ["string"]
}
```

#### GET /api/auth/me
**Описание:** Получение информации о текущем пользователе

**Headers:**
- `Authorization: Bearer <token>`

**Response 200:**
```json
{
  "id": 1,
  "username": "string",
  "email": "string",
  "fullName": "string",
  "position": "string",
  "department": "string",
  "roles": ["string"],
  "createdAt": "2024-01-01T00:00:00",
  "isActive": true
}
```

### 6.2. Магазины

#### GET /api/references/stores
**Описание:** Получение списка всех магазинов

**Response 200:**
```json
[
  {
    "id": 1,
    "mvz": "13CT0979",
    "name": "Пятёрочка №123",
    "address": "г. Москва, ул. Ленина, д. 10",
    "cfo": "E1028750",
    "oktmo": "45339000",
    "hasRestriction": false,
    "munArea": "Москва",
    "munDistrict": "Москва",
    "be": "ООО «Агроторг»",
    "closeDate": null,
    "directorPhone": "+7 (999) 123-45-67",
    "inn": "7701234567",
    "kpp": "770101001",
    "contactPerson": "Иванов Иван",
    "phone": "+7 (999) 123-45-67",
    "email": "store@example.com",
    "alcoholLicenseExpiry": "2025-12-31",
    "tobaccoLicenseExpiry": "2025-12-31",
    "isActive": true
  }
]
```

#### GET /api/references/stores/{id}
**Описание:** Получение магазина по ID

**Response 200:** (объект Store)

#### POST /api/references/stores
**Описание:** Создание нового магазина

**Request Body:**
```json
{
  "name": "string",
  "inn": "string",
  "address": "string",
  "kpp": "string",
  "contactPerson": "string",
  "phone": "string",
  "email": "string"
}
```

**Response 200:** (объект Store)

### 6.3. Регионы

#### GET /api/references/regions
**Описание:** Получение списка регионов

**Response 200:**
```json
[
  {
    "id": 1,
    "licenseType": "string",
    "name": "Москва",
    "regionCode": "77",
    "regionGiid": "string",
    "counterpartyCode": "string",
    "counterpartyInn": "string",
    "kpp": "string",
    "settlementBik": "string",
    "createdAt": "2024-01-01T00:00:00",
    "updatedAt": "2024-01-01T00:00:00"
  }
]
```

#### POST /api/references/regions
**Описание:** Создание региона

**Request Body:**
```json
{
  "name": "string",
  "licenseType": "string",
  "regionCode": "string"
}
```

### 6.4. Платежи

#### GET /api/payments
**Описание:** Получение списка платежей

**Response 200:**
```json
[
  {
    "id": 1,
    "amount": 1000.00,
    "status": "PENDING",
    "type": "STATE_FEE",
    "paymentDate": null,
    "paymentReference": "string",
    "notes": "string",
    "region": "Москва",
    "retailNetwork": "string",
    "legalEntity": "string",
    "paymentRecipient": "string",
    "storeIds": [1, 2],
    "createdAt": "2024-01-01T00:00:00"
  }
]
```

#### POST /api/payments
**Описание:** Создание платежа

**Request Body:**
```json
{
  "amount": 1000.00,
  "type": "STATE_FEE",
  "region": "Москва",
  "storeIds": [1, 2],
  "notes": "string"
}
```

#### PUT /api/payments/{id}/status?status={status}
**Описание:** Обновление статуса платежа

**Query Parameters:**
- `status`: PENDING | COMPLETED | FAILED | CANCELLED

### 6.5. Выписки ЕГРН

#### GET /api/egrn-extracts
**Описание:** Получение списка выписок

**Response 200:**
```json
[
  {
    "id": 1,
    "applicantType": "string",
    "phone": "string",
    "email": "string",
    "cadastralNumber": "string",
    "objectType": "string",
    "mvz": "string",
    "status": "DRAFT",
    "createdAt": "2024-01-01T00:00:00"
  }
]
```

#### POST /api/egrn-extracts
**Описание:** Создание выписки

**Request Body:**
```json
{
  "applicantType": "string",
  "phone": "string",
  "email": "string",
  "cadastralNumber": "string",
  "objectType": "string",
  "mvz": "string"
}
```

---

## 7. UI/UX Требования

### 7.1. Дизайн-система

**Цветовая палитра:**
- Основной цвет: #1890ff (синий)
- Успех: #52c41a (зеленый)
- Предупреждение: #faad14 (оранжевый)
- Ошибка: #ff4d4f (красный)
- Фон: #fafafa (светло-серый)
- Текст: #262626 (темно-серый)

**Типографика:**
- Основной шрифт: системный (Arial, Helvetica, sans-serif)
- Заголовки: 24px, 20px, 16px
- Основной текст: 14px
- Мелкий текст: 12px

**Компоненты:**
- Использование Ant Design компонентов
- Скругление углов: 8px, 16px
- Тени: 0 4px 12px rgba(0,0,0,0.05)
- Отступы: 8px, 16px, 24px

### 7.2. Навигация

**Структура меню:**
- Главная (Dashboard)
- Задачи
- Платежи
- Выписки ЕГРН
- Анализ локации
- Договоры аренды
- Справочники:
  - Магазины
  - Регионы РФ
  - Алкогольные лицензии
  - Табачные лицензии

**Боковая панель:**
- Сворачиваемая (collapsible)
- Фиксированная позиция
- Темная тема
- Логотип вверху
- Профиль пользователя внизу

### 7.3. Адаптивность

**Breakpoints:**
- Desktop: ≥ 1280px
- Tablet: 768px - 1279px
- Mobile: < 768px

**Адаптивное поведение:**
- Таблицы с горизонтальной прокруткой на мобильных
- Сворачивание боковой панели на планшетах
- Вертикальное расположение элементов на мобильных

### 7.4. Интерактивность

**Drag & Drop:**
- Перетаскивание виджетов на дашборде
- Перетаскивание тайлов внутри секций
- Визуальная обратная связь при перетаскивании

**Формы:**
- Валидация в реальном времени
- Подсказки при ошибках
- Автосохранение (опционально)

**Модальные окна:**
- Затемнение фона
- Закрытие по клику вне окна или ESC
- Анимация появления/исчезновения

---

## 8. Безопасность

### 8.1. Аутентификация и авторизация

**JWT токены:**
- Алгоритм: HS256
- Секретный ключ: хранится в application.yml
- Время жизни: 24 часа
- Обновление токена: через повторный логин

**Пароли:**
- Минимальная длина: 8 символов (рекомендуется)
- Хеширование: BCrypt (10 rounds)
- Хранение: только хеш, никогда plain text

**Роли:**
- ADMIN — полный доступ
- MANAGER — работа с задачами и документами
- VIEWER — только просмотр

### 8.2. Защита данных

**Валидация входных данных:**
- Проверка на стороне клиента (TypeScript типы)
- Проверка на стороне сервера (Bean Validation)
- Санитизация строковых данных

**SQL инъекции:**
- Использование JPA/Hibernate (параметризованные запросы)
- Запрет на использование нативных SQL без параметров

**XSS:**
- Экранирование HTML в выводе
- Использование React (автоматическое экранирование)

**CSRF:**
- Отключено для API (используется JWT)
- Для форм: токены CSRF (если потребуется)

### 8.3. Логирование и аудит

**Логирование:**
- Уровни: DEBUG, INFO, WARN, ERROR
- Логирование попыток входа
- Логирование критических операций (создание, удаление)
- Ротация логов

**Аудит:**
- Отслеживание изменений данных (опционально)
- История действий пользователей (опционально)

---

## 9. Развертывание

### 9.1. Development окружение

**Требования:**
- Node.js 18+
- Java 17+
- Maven 3.8+
- PostgreSQL 15+

**Запуск Backend:**
```bash
cd backend
./mvnw spring-boot:run
```

**Запуск Frontend:**
```bash
cd frontend
npm install
npm run dev
```

**Настройка БД:**
1. Создать базу данных: `CREATE DATABASE licensing_portal;`
2. Обновить `application.yml` с credentials
3. Flyway автоматически применит миграции

### 9.2. Production окружение

**Рекомендуемая конфигурация:**
- Nginx как reverse proxy
- SSL сертификат (Let's Encrypt)
- Резервное копирование БД (ежедневно)
- Мониторинг (опционально)

**Переменные окружения:**
- `SPRING_DATASOURCE_URL`
- `SPRING_DATASOURCE_USERNAME`
- `SPRING_DATASOURCE_PASSWORD`
- `JWT_SECRET`
- `SMTP_HOST`, `SMTP_USERNAME`, `SMTP_PASSWORD`

**Docker (опционально):**
- Dockerfile для backend
- Dockerfile для frontend
- docker-compose.yml для полного стека

### 9.3. Миграции БД

**Flyway:**
- Миграции в `src/main/resources/db/migration/`
- Именование: `V{version}__{description}.sql`
- Автоматическое применение при старте приложения
- Откат через Flyway CLI

---

## 10. Тестирование

### 10.1. Типы тестов

**Unit тесты:**
- Тестирование сервисов
- Тестирование утилит
- Покрытие: ≥ 70%

**Integration тесты:**
- Тестирование API endpoints
- Тестирование репозиториев
- Тестирование безопасности

**E2E тесты (опционально):**
- Тестирование критических сценариев
- Использование Cypress или Playwright

### 10.2. Тестовые данные

**Фикстуры:**
- Тестовые пользователи
- Тестовые магазины
- Тестовые регионы
- Тестовые платежи

**Очистка:**
- Автоматическая очистка после тестов
- Использование @Transactional в тестах

---

## 11. Документация

### 11.1. Техническая документация

**Код:**
- JavaDoc для Java классов и методов
- Комментарии для сложной логики
- README.md с инструкциями по запуску

**API:**
- Swagger/OpenAPI документация (опционально)
- Описание endpoints в комментариях

### 11.2. Пользовательская документация

**Руководство пользователя:**
- Инструкции по работе с системой
- Описание функций
- FAQ

**Административная документация:**
- Инструкции по развертыванию
- Настройка окружения
- Резервное копирование

---

## 12. План развития

### 12.1. Текущие задачи

1. **Завершение модуля задач:**
   - Реализация страницы Tasks
   - API для работы с задачами
   - Интеграция с другими модулями

2. **Рефакторинг модели Task:**
   - Удаление подзадач
   - Переход на единую модель с разделами
   - Обновление DTO и сервисов

3. **Модуль документов:**
   - Загрузка файлов
   - Хранение файлов
   - Версионирование документов

### 12.2. Будущие улучшения

1. **Интеграции:**
   - Интеграция с реальным API ЕГРН
   - Интеграция с ГИС системами
   - Интеграция с ФИАС API

2. **Аналитика:**
   - Расширенная аналитика по лицензиям
   - Экспорт отчетов (PDF, Excel)
   - Графики и диаграммы

3. **Уведомления:**
   - Email уведомления
   - Push уведомления (опционально)
   - Настройка уведомлений пользователем

4. **Мобильное приложение:**
   - React Native приложение
   - Основные функции на мобильных устройствах

5. **Автоматизация:**
   - Автоматическое создание задач при приближении истечения лицензий
   - Автоматическая отправка уведомлений
   - Автоматическая синхронизация с внешними системами

---

## 13. Глоссарий

**МВЗ** — Место ведения деятельности (код магазина)

**ЦФО** — Центр финансовой ответственности

**ОКТМО** — Общероссийский классификатор территорий муниципальных образований

**ЕГРН** — Единый государственный реестр недвижимости

**ГИС** — Геоинформационная система

**ФИАС** — Федеральная информационная адресная система

**БЕ** — Бизнес-единица

**ГИИД** — Глобальный уникальный идентификатор

**JWT** — JSON Web Token

**REST** — Representational State Transfer

**API** — Application Programming Interface

**ORM** — Object-Relational Mapping

**CRUD** — Create, Read, Update, Delete

---

## 14. Приложения

### 14.1. Схема базы данных (ER-диаграмма)

```
users ──┐
        ├── user_roles
        │
        ├── documents (uploaded_by_id)
        │
        ├── notifications (user_id)
        │
        └── tasks (assignee_id, created_by_id)

stores ──┐
        ├── payment_stores ── payments
        │
        └── tasks (store_id)

regions

payments ── payment_stores ── stores

egrn_extracts

notifications ── users

documents ── users

tasks ── stores
tasks ── users (assignee_id)
tasks ── users (created_by_id)
```

### 14.2. Примеры конфигурационных файлов

**application.yml (production):**
```yaml
spring:
  datasource:
    url: jdbc:postgresql://${DB_HOST}:${DB_PORT}/${DB_NAME}
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
  
  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false

jwt:
  secret: ${JWT_SECRET}
  expiration: 86400000

server:
  port: 8081
```

**vite.config.ts:**
```typescript
export default defineConfig({
  plugins: [react()],
  server: {
    port: 5174,
    proxy: {
      '/api': {
        target: 'http://localhost:8081',
        changeOrigin: true
      }
    }
  }
})
```

---

**Конец документа**

---

*Документ подготовлен на основе анализа кодовой базы проекта licensing-portal*  
*Версия: 1.0*  
*Дата: 2024*

